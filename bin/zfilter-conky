#!/bin/sh
. ~/bin/functions

BATHIGH=80
BATLOW=30

DFT_CONKY_TEXT='${cpu cpu0} ${loadavg 1 2 3} ${memperc} ${downspeed eth0} ${upspeed eth0}'
[ "$CONKY_TEXT" ]||CONKY_TEXT="$DFT_CONKY_TEXT"

PIPE=$HOME/.conky-status
rm -f $PIPE && mkfifo -m 622 $PIPE
[ -p $PIPE ] || exit
conky-cli -u 2 -t "$CONKY_TEXT" >$PIPE &

batbar() {
    val=${1/\%/} # remove trailing %
    if [ $val -gt $BATHIGH ]; then
        fg=green
    elif [ $val -gt $BATLOW ]; then
        fg=yellow
    else
        fg=red
    fi
    dz_vbar $val $fg $bg
}

img_net=`dz_image net-wifi`
img_cpu=`dz_image cpu`
img_mem=`dz_image mem`
img_up=`dz_image arr_up`
img_down=`dz_image arr_down`
img_load=`dz_image load`
img_batt=`dz_image battery`

while read cpu load1 load2 load3 mem netdown netup batstat batpercent; do
    echo -n "$img_cpu $cpu% `dz_vbar $cpu blue`"
    echo -n ' | '
    echo -n "$img_load $load1 $load2 $load3"
    echo -n ' | '
    echo -n "$img_mem RAM $mem% `dz_vbar $mem red`"
    echo -n ' | '

    if [ $batstat ]; then
        echo -n "$img_batt $batstat $batpercent `batbar $batpercent`"
        echo -n ' | '
    fi

    echo -n "$img_net "
    [ $netdown -gt 0 ] && fgcolor="#99cc33" || fgcolor=''
    echo -n "`dz_fg "$fgcolor" "${netdown}k/s $img_down"` "
    [ $netup -gt 0 ] && fgcolor="#ff3300" || fgcolor=''
    echo -n "`dz_fg "$fgcolor" "${netup}k/s $img_up"`"
    echo -n ' | '

    datetime=`date +"%a %d %b %I:%M:%S%P"`
    echo -n `dz_fg white "$datetime"`
    echo
done <$PIPE
