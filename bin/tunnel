#!/bin/bash -x
#
# usage:
#     tunnel [endpoint]

declare -A ENDPOINT
ENDPOINT[c1]="head1.scrapinghub.com http://head1:8088 http://head1:19888 http://head1:60010 http://head2:60010 http://head1:50070 http://head2:50070 http://head2:9000" 
ENDPOINT[c2]="head1.c2.scrapinghub.com http://head1:8088 http://head1:19888 http://head1:60010 http://head2:60010 http://head1:50070 http://head2:50070 http://head2:9000" 
ENDPOINT[hadoop-dev]="disco1.eu.scrapinghub.com http://172.16.1.1:8088 http://172.16.1.1:60010"
ENDPOINT[disco]="disco.eu.scrapinghub.com http://disco:8989"
ENDPOINT[disco-us]="disco.scrapinghub.com http://disco:8989"
ENDPOINT[disco-bh]="disco.bitehunter.com http://disco:8989"
ENDPOINT[dev]="dev.scrapinghub.com"

for bin in google-chrome{,-stable,-beta,-unstable} chromium-browser; do
  CHROMEBIN=$(type -p $bin)
  [[ -z $CHROMEBIN ]] || break
done
[[ $CHROMEBIN ]] || { echo "ERROR: chrome or chromium binary not found"; exit -1; }

_tunnel() {
    local name=$1 host=$2
    shift 2
    local urls=("$@")
    local userdata=$HOME/.config/tunnel-$name
    local portfn=$userdata/socksport
    local port proxy
    mkdir -p "$userdata" && touch "$userdata/First Run";
    [[ -r $portfn ]] || echo $(($RANDOM%10000+10000)) >$portfn
    port=$(cat $portfn)
    proxy=socks5://localhost:$port
    ssh -q -C -N -f -o ExitOnForwardFailure=yes $host -D $port
    $CHROMEBIN --user-data-dir=$userdata --proxy-server=$proxy ${urls[@]}
}

main() {
    local name=${1:-hadoop}
    local endpoint=(${ENDPOINT[$name]})
    [[ $endpoint ]] || { echo "invalid endpoint for: $name"; exit -1; }
    _tunnel $name ${endpoint[@]} &
}

main "$@"
