#!/bin/bash
#
# usage:
# 	tunnel-to-hadoop [region]
#
# where "region" is "eu" or "us" (default is "us")
#
declare -A REGIONPORT
REGIONPORT[eu]=16666
REGIONPORT[us]=16667

_forward_and_tunnel() {
	local region=$1 port=$2 url=$3 userdatadir proxyserver
	userdatadir=$HOME/.config/tunnel-to-hadoop/$region
	proxyserver=socks5://localhost:$port
	# touch data dir to skip first run dialogs
	[[ -d $userdatadir ]] || { mkdir $userdatadir; touch "$userdatadir/First Run"; }
	# Dynamic Forward port to localhost:$port
	ssh -C -N -f -D $port indexer.ec2.$region.mydeco.com -o ExitOnForwardFailure=yes
	# Start chrome preconfigured to use previously set socks5 proxy
	google-chrome --user-data-dir=$HOME/.config/tunnel-to-hadoop/$region \
		--proxy-server="socks5://localhost:$port" \
		$url
}

main() {
	local regions url region port
	regions=${1:-us eu}
	for region in $regions; do
		port=${REGIONPORT[$region]:-6667}
		url=${2:-http://hadoop.ec2.$region.mydeco.com:50030}
		_forward_and_tunnel $region $port $url &
	done 
}

main "$@"
