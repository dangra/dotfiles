#!/bin/bash
#
# usage:
# 	tunnel-to-hadoop [region] [url]
#
# where "region" is "eu" or "us", by default all regions are started
#

CHROMEBIN=$(type -p google-chrome || type -p chromium-browser)
declare -A REGIONPORT
REGIONPORT[eu]=16666
REGIONPORT[us]=16667

[[ $CHROMEBIN ]] || { echo "ERROR: chrome or chromium binary not found"; exit -1; }

_forward_and_tunnel() {
	local region=$1 port=$2 url=$3 userdatadir proxyserver
	userdatadir=$HOME/.config/tunnel-to-hadoop/$region
	proxyserver=socks5://localhost:$port
	# touch data dir to skip first run dialogs
	[[ -d $userdatadir ]] || { mkdir -p $userdatadir; touch "$userdatadir/First Run"; }
	# Dynamic Forward port to localhost:$port
	ssh -C -N -f -o ExitOnForwardFailure=yes -D $port indexer.ec2.$region.mydeco.com
	# Start chrome preconfigured to use previously set socks5 proxy
	$CHROMEBIN --user-data-dir=$userdatadir --proxy-server=$proxyserver $url
}

main() {
	local regions=${1:-us eu} url region port
	for region in $regions; do
		port=${REGIONPORT[$region]}
		[[ $port ]] || { echo "ERROR: invalid region '$region'"; exit -1; }
		url=${2:-http://hadoop.ec2.$region.mydeco.com:50030}
		_forward_and_tunnel $region $port $url &
	done 
}

main "$@"
